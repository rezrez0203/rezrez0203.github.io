<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>バナナシューティングゲーム</title>
  <style>
    * {
      user-select: none;
      margin: 0;
      padding: 0;
    }
    body {
      background: #fff;
      overflow: hidden;
      height: 100vh;
      position: relative;
      font-family: sans-serif;
    }

    #gameArea {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: #eef;
    }

    #player {
      position: absolute;
      bottom: 20px;
      left: 50%;
      width: 60px;
      height: 60px;
      margin-left: 0;
      background-image: url('https://cdn-icons-png.flaticon.com/512/415/415716.png'); /* バナナ画像 */
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      cursor: pointer;
      z-index: 10;
    }

    .bullet {
      position: absolute;
      width: 8px;
      height: 20px;
      background: #e74c3c;
      border-radius: 4px;
      z-index: 20;
    }

    .enemy {
      position: absolute;
      width: 50px;
      height: 50px;
      background-image: url('https://cdn-icons-png.flaticon.com/512/415/415733.png'); /* リンゴ */
      background-size: contain;
      background-repeat: no-repeat;
      z-index: 15;
    }

    #score, #timer {
      position: fixed;
      top: 10px;
      background: rgba(255,255,255,0.8);
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: bold;
      font-size: 24px;
      user-select: none;
      z-index: 30;
    }

    #score {
      left: 10px;
    }

    #timer {
      right: 10px;
    }

    #messageContainer {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 50;
      user-select: none;
      display: none;
    }

    #message {
      font-size: 48px;
      font-weight: bold;
      color: #cc0000;
      margin-bottom: 20px;
    }

    #restartBtn {
      font-size: 24px;
      padding: 10px 30px;
      border: none;
      border-radius: 10px;
      background-color: #28a745;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    #restartBtn:hover {
      background-color: #218838;
    }
  </style>
</head>
<body>
  <div id="gameArea">
    <div id="player"></div>
  </div>

  <div id="score">得点: 0</div>
  <div id="timer">残り時間: 30秒</div>

  <div id="messageContainer">
    <div id="message">ゲーム終了！</div>
    <button id="restartBtn">再スタート</button>
  </div>

  <script>
    window.onload = () => {
      const gameArea = document.getElementById('gameArea');
      const player = document.getElementById('player');
      const scoreDisplay = document.getElementById('score');
      const timerDisplay = document.getElementById('timer');
      const messageContainer = document.getElementById('messageContainer');
      const restartBtn = document.getElementById('restartBtn');

      let score = 0;
      let timeLeft = 30;
      let gameRunning = true;

      // 弾と敵の配列（敵は {element, speed}）
      let bullets = [];
      let enemies = [];

      // ゲームエリアサイズ（更新できるように関数に）
      function getGameSize() {
        return { width: window.innerWidth, height: window.innerHeight };
      }

      // プレイヤー移動関数（右端まで動けるように調整）
      function movePlayer(x) {
        const { width: gameWidth } = getGameSize();
        const playerWidth = player.offsetWidth;
        // 0からゲーム幅-player幅までが移動範囲
        const clampedX = Math.min(Math.max(x, 0), gameWidth - playerWidth);
        player.style.left = clampedX + "px";
      }

      // マウス・タッチでプレイヤー操作
      function onPointerMove(e) {
        let clientX = e.clientX || (e.touches && e.touches[0].clientX);
        if (clientX !== undefined) {
          movePlayer(clientX - player.offsetWidth / 2);
        }
      }
      window.addEventListener("mousemove", onPointerMove);
      window.addEventListener("touchmove", onPointerMove);

      const bulletInterval = 200;
      let lastBulletTime = 0;

      // 弾作成（プレイヤーの真ん中から）
      function createBullet() {
        const bullet = document.createElement('div');
        bullet.className = 'bullet';

        const playerRect = player.getBoundingClientRect();
        const gameAreaRect = gameArea.getBoundingClientRect();

        const bulletLeft = playerRect.left - gameAreaRect.left + playerRect.width / 2 - 4; // 弾幅8/2=4px
        const bulletTop = playerRect.top - gameAreaRect.top - 20;

        bullet.style.left = bulletLeft + 'px';
        bullet.style.top = bulletTop + 'px';

        gameArea.appendChild(bullet);
        bullets.push(bullet);
      }

      // 敵作成（速度ランダム）
      function createEnemy() {
        const enemy = document.createElement('div');
        enemy.className = 'enemy';
        const { width: gameWidth } = getGameSize();
        const x = Math.random() * (gameWidth - 50);
        enemy.style.left = x + 'px';
        enemy.style.top = '-50px';
        gameArea.appendChild(enemy);
        const speed = 2 + Math.random() * 3; // 2〜5のランダム速度
        enemies.push({ element: enemy, speed });
      }

      // 衝突判定
      function isCollision(a, b) {
        const rectA = a.getBoundingClientRect();
        const rectB = b.getBoundingClientRect();

        return !(
          rectA.right < rectB.left ||
          rectA.left > rectB.right ||
          rectA.bottom < rectB.top ||
          rectA.top > rectB.bottom
        );
      }

      // スコア更新
      function updateScore() {
        scoreDisplay.textContent = `得点: ${score}`;
      }

      // タイマー更新
      function updateTimer() {
        timerDisplay.textContent = `残り時間: ${timeLeft}秒`;
      }

      // ゲーム終了処理
      function endGame() {
        gameRunning = false;
        messageContainer.style.display = "block";
      }

      // ゲームループ
      function gameLoop(timestamp) {
        if (!gameRunning) return;

        if (!lastBulletTime || timestamp - lastBulletTime > bulletInterval) {
          createBullet();
          lastBulletTime = timestamp;
        }

        // 弾の移動
        bullets.forEach((bullet, i) => {
          let top = parseFloat(bullet.style.top);
          top -= 8;
          if (top < -20) {
            bullet.remove();
            bullets.splice(i, 1);
          } else {
            bullet.style.top = top + 'px';
          }
        });

        // 敵の移動
        enemies.forEach(({ element, speed }, i) => {
          let top = parseFloat(element.style.top);
          top += speed;
          const { height: gameHeight } = getGameSize();
          if (top > gameHeight) {
            element.remove();
            enemies.splice(i, 1);
          } else {
            element.style.top = top + 'px';
          }
        });

        // 衝突判定
        bullets.forEach((bullet, bi) => {
          enemies.forEach(({ element: enemy }, ei) => {
            if (isCollision(bullet, enemy)) {
              bullet.remove();
              enemy.remove();
              bullets.splice(bi, 1);
              enemies.splice(ei, 1);
              score++;
              updateScore();
            }
          });
        });

        requestAnimationFrame(gameLoop);
      }

      // ランダム間隔で敵生成
      let enemyTimer;
      function spawnEnemyRandom() {
        if (!gameRunning) return;
        createEnemy();
        const nextTime = 500 + Math.random() * 1000; // 0.5〜1.5秒
        enemyTimer = setTimeout(spawnEnemyRandom, nextTime);
      }

      // カウントダウン
      let countdownTimeout;
      function countdown() {
        if (timeLeft <= 0) {
          endGame();
          clearTimeout(enemyTimer);
          clearTimeout(countdownTimeout);
          return;
        }
        updateTimer();
        timeLeft--;
        countdownTimeout = setTimeout(countdown, 1000);
      }

      // 再スタート処理
      restartBtn.addEventListener('click', () => {
        bullets.forEach(b => b.remove());
        enemies.forEach(({ element }) => element.remove());
        bullets = [];
        enemies = [];

        score = 0;
        timeLeft = 30;
        gameRunning = true;
        messageContainer.style.display = 'none';
        updateScore();
        updateTimer();

        const { width: gameWidth } = getGameSize();
        movePlayer(gameWidth / 2 - player.offsetWidth / 2);

        clearTimeout(enemyTimer);
        spawnEnemyRandom();
        countdown();
        requestAnimationFrame(gameLoop);
      });

      // 初期化
      updateScore();
      updateTimer();
      const { width: gameWidth } = getGameSize();
      movePlayer(gameWidth / 2 - player.offsetWidth / 2);
      spawnEnemyRandom();
      countdown();
      requestAnimationFrame(gameLoop);

      // ウィンドウリサイズ対応（右端判定のため）
      window.addEventListener('resize', () => {
        if (!gameRunning) return;
        const { width: gameWidth } = getGameSize();
        // プレイヤーがはみ出たら押し戻す
        const currentLeft = parseFloat(player.style.left);
        if (currentLeft + player.offsetWidth > gameWidth) {
          movePlayer(gameWidth - player.offsetWidth);
        }
      });
    };
  </script>
</body>
</html>